<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.30">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Badge 7 Document Feature Representation</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/clipboard/clipboard.min.js"></script>
<script src="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/quarto-html/quarto.js"></script>
<script src="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/quarto-html/popper.min.js"></script>
<script src="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/quarto-html/anchor.min.js"></script>
<link href="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/quarto-html/quarto-syntax-highlighting-3a01e2046221230fdceeea94b1ec5d67.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="nlp_badge_07_Document_Feature_Representation_1.7_files/libs/bootstrap/bootstrap-34745567add538a638dde46bc8a747e1.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Badge 7 Document Feature Representation</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="document-feature-representation" class="level1">
<h1>Document Feature Representation</h1>
<p>In this badge we are going to explore different ways to create document vector representations with the <em>tm, quanteda</em> and <em>tidytext</em> package. We are going to create Bag of Word vectors (using frequency counts) and TF-IDF. We will put these vectors into document frequencies tables (we talked about these in week2).</p>
<p>These packages have differing functionalities for doing things like lower case, punctuation removal, stemming etc. You may find you want to mix and match the functionalities so it is useful to be able to move data between these packages.</p>
<p>Let’s make sure we have the packages we need installed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># WHEN YOU RUN THIS CODE, YOU MIGHT BE ASKED IF YOU'D LIKE TO RELOAD RSTUDIO: **ANSWER 'NO'**</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># for all packages we need:</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">install.packages</span>(<span class="st">"pacman"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
The downloaded binary packages are in
    /var/folders/gl/gg126_x15pqfgb8m_4wzfnnh0000gn/T//Rtmp4c06ry/downloaded_packages</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tm, quanteda, tidytext, dplyr, tidyverse, pryr, chunked, data.table)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>As we install more and more packages, sometimes you start thinking <code>Which package does this specific function come from?</code>. Code R has a wonderful function for you called <code>find( FUNCTION_NAME )</code>. You can pass any FUNCTION_NAME into it, and you’ll find out which package it comes from!</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span>(<span class="st">"print"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "package:quanteda" "package:base"    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span>(<span class="st">"find"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "package:utils"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span>(<span class="st">"tm_map"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "package:tm"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span>(<span class="st">"data.frame"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "package:base"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">find</span>(<span class="st">"inspect"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "package:pryr" "package:tm"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># notice that some functions like `inspect` are defined in many libraries. </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># to be sure which one you're useing you'd call them as pryr::inspect or tm::inspect (you'll see this later)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next let’s create a sample dataframe with one column for document IDs and one column for text. It’s easier to work with a small sample set of text first to see what is going on.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample dataframe</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">doc_id =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>,</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">text =</span> <span class="fu">c</span>(<span class="st">"John Smith went to Edinburgh"</span>, </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>           <span class="st">"Alice Swift lives in Paris"</span>, </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>           <span class="st">"Taylor Swift lives in USA"</span>),</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">stringsAsFactors =</span> <span class="cn">FALSE</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co"># let's see what's in it:</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>df</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  doc_id                         text
1      1 John Smith went to Edinburgh
2      2   Alice Swift lives in Paris
3      3    Taylor Swift lives in USA</code></pre>
</div>
</div>
<section id="method-1-we-will-use-the-tm-package" class="level2">
<h2 class="anchored" data-anchor-id="method-1-we-will-use-the-tm-package">Method 1: We will use the <code>tm</code> package</h2>
<p>The <code>tm</code> package is a popular choice for text mining in R as it provides easy-to-use tools to create DTMs and apply term frequency (TF) and term frequency-inverse document frequency (TF-IDF) weightings. DTMs hold our nerical representations of the document - our document vectors.</p>
<ol type="1">
<li>Install and Load <code>tm</code></li>
<li>Create a Document-Term Matrix with our sample data, here we are counting the frequencies of our terms so we are creating bag of words vectors</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Corpus from the text column</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>corpus <span class="ot">&lt;-</span> <span class="fu">Corpus</span>(<span class="fu">VectorSource</span>(df<span class="sc">$</span>text))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DTM with term frequencies</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>dtm <span class="ot">&lt;-</span> <span class="fu">DocumentTermMatrix</span>(corpus)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="co"># View DTM (note inspect only looks and 10 columns)</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>tm<span class="sc">::</span><span class="fu">inspect</span>(dtm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 3, terms: 10)&gt;&gt;
Non-/sparse entries: 12/18
Sparsity           : 60%
Maximal term length: 9
Weighting          : term frequency (tf)
Sample             :
    Terms
Docs alice edinburgh john lives paris smith swift taylor usa went
   1     0         1    1     0     0     1     0      0   0    1
   2     1         0    0     1     1     0     1      0   0    0
   3     0         0    0     1     0     0     1      1   1    0</code></pre>
</div>
</div>
<p>Next let’s apply TF-IDF Weighting to our frequencies.</p>
<p>To apply TF-IDF weighting to the DTM we use <code>weightTfIdf</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply TF-IDF weighting</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>dtm_tfidf <span class="ot">&lt;-</span> <span class="fu">weightTfIdf</span>(dtm)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># View TF-IDF weighted DTM</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>tm<span class="sc">::</span><span class="fu">inspect</span>(dtm_tfidf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 3, terms: 10)&gt;&gt;
Non-/sparse entries: 12/18
Sparsity           : 60%
Maximal term length: 9
Weighting          : term frequency - inverse document frequency (normalized) (tf-idf)
Sample             :
    Terms
Docs     alice edinburgh      john     lives     paris     smith     swift
   1 0.0000000 0.3962406 0.3962406 0.0000000 0.0000000 0.3962406 0.0000000
   2 0.3962406 0.0000000 0.0000000 0.1462406 0.3962406 0.0000000 0.1462406
   3 0.0000000 0.0000000 0.0000000 0.1462406 0.0000000 0.0000000 0.1462406
    Terms
Docs    taylor       usa      went
   1 0.0000000 0.0000000 0.3962406
   2 0.0000000 0.0000000 0.0000000
   3 0.3962406 0.3962406 0.0000000</code></pre>
</div>
</div>
</section>
<section id="activity-reading-documentation-of-a-function" class="level2">
<h2 class="anchored" data-anchor-id="activity-reading-documentation-of-a-function">ACTIVITY: Reading documentation of a function</h2>
<p>Have a look at the <code>tm</code> package vignette to see some of the other functions. Try applying stopword removal or punctuation stripping to your corpus before creating the document term frequencies.</p>
<p><a href="https://cran.r-project.org/web/packages/tm/vignettes/tm.pdf">Link to Vignette</a></p>
<p>Wait WHAT IS A VIGNETTE? It is an online fine with the official documentation of a given function.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># your code here</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(df)</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="co"># stop word removal</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>df_stop <span class="ot">&lt;-</span> df[<span class="co"># unnest</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>  , <span class="fu">unnest_tokens</span>(.SD, word, text)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>  ][ <span class="co"># remove stop wordsdf</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>    <span class="sc">!</span>word <span class="sc">%in%</span> stop_words<span class="sc">$</span>word</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>  ][ <span class="co"># merge back into string</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>    , .(<span class="at">text =</span> <span class="fu">paste</span>(word, <span class="at">collapse =</span> <span class="st">" "</span>)), by <span class="ot">=</span> doc_id</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>df_stop</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   doc_id                    text
    &lt;int&gt;                  &lt;char&gt;
1:      1    john smith edinburgh
2:      2 alice swift lives paris
3:      3  taylor swift lives usa</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Corpus from the text column</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>corpus_stop <span class="ot">&lt;-</span> <span class="fu">Corpus</span>(<span class="fu">VectorSource</span>(df_stop<span class="sc">$</span>text))</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a DTM with term frequencies</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>dtm_stop <span class="ot">&lt;-</span> <span class="fu">DocumentTermMatrix</span>(corpus_stop)</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># View DTM (note inspect only looks and 10 columns)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>tm<span class="sc">::</span><span class="fu">inspect</span>(dtm_stop)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 3, terms: 9)&gt;&gt;
Non-/sparse entries: 11/16
Sparsity           : 59%
Maximal term length: 9
Weighting          : term frequency (tf)
Sample             :
    Terms
Docs alice edinburgh john lives paris smith swift taylor usa
   1     0         1    1     0     0     1     0      0   0
   2     1         0    0     1     1     0     1      0   0
   3     0         0    0     1     0     0     1      1   1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply TF-IDF weighting</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>dtm_stop_tfidf <span class="ot">&lt;-</span> <span class="fu">weightTfIdf</span>(dtm_stop)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="co"># View TF-IDF weighted DTM</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>tm<span class="sc">::</span><span class="fu">inspect</span>(dtm_stop_tfidf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 3, terms: 9)&gt;&gt;
Non-/sparse entries: 11/16
Sparsity           : 59%
Maximal term length: 9
Weighting          : term frequency - inverse document frequency (normalized) (tf-idf)
Sample             :
    Terms
Docs     alice edinburgh      john     lives     paris     smith     swift
   1 0.0000000 0.5283208 0.5283208 0.0000000 0.0000000 0.5283208 0.0000000
   2 0.3962406 0.0000000 0.0000000 0.1462406 0.3962406 0.0000000 0.1462406
   3 0.0000000 0.0000000 0.0000000 0.1462406 0.0000000 0.0000000 0.1462406
    Terms
Docs    taylor       usa
   1 0.0000000 0.0000000
   2 0.0000000 0.0000000
   3 0.3962406 0.3962406</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># OR, using corpus... this seems to use a different stop_words list</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="co"># use tm_map with some transformation...</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">getTransformations</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "removeNumbers"     "removePunctuation" "removeWords"      
[4] "stemDocument"      "stripWhitespace"  </code></pre>
</div>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Remove stop words</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>corpus <span class="ot">&lt;-</span> <span class="fu">tm_map</span>(corpus, removeWords, <span class="fu">stopwords</span>(<span class="st">"en"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tm_map.SimpleCorpus(corpus, removeWords, stopwords("en")):
transformation drops documents</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>corpus</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;SimpleCorpus&gt;&gt;
Metadata:  corpus specific: 1, document level (indexed): 0
Content:  documents: 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>dtm_stop2 <span class="ot">&lt;-</span> <span class="fu">DocumentTermMatrix</span>(corpus)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>tm<span class="sc">::</span><span class="fu">inspect</span>(dtm_stop2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 3, terms: 10)&gt;&gt;
Non-/sparse entries: 12/18
Sparsity           : 60%
Maximal term length: 9
Weighting          : term frequency (tf)
Sample             :
    Terms
Docs alice edinburgh john lives paris smith swift taylor usa went
   1     0         1    1     0     0     1     0      0   0    1
   2     1         0    0     1     1     0     1      0   0    0
   3     0         0    0     1     0     0     1      1   1    0</code></pre>
</div>
</div>
<p>If you’ve been trying for a few minutes, but cannot find above options in the documentation, just a look at the answer: <a href="./hints/hint_7_1.Rmd">Hint: Answer</a></p>
<p>OK, let’s use this method on some real data: We have used a sample data frame but you might be wondering, how would I get my Corona tweet text data into tm as a corpus.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Load the corona csv to a datframe</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>file_path<span class="ot">=</span><span class="st">'./data/CORONA_TWEETS.csv'</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>Corona_NLP_DF <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(file_path, <span class="at">stringsAsFactors =</span><span class="cn">FALSE</span>, <span class="at">header=</span><span class="cn">TRUE</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">setDT</span>(Corona_NLP_DF)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="co">#Call the Corona text column using the $ operator</span></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>myCorpus <span class="ot">&lt;-</span> <span class="fu">Corpus</span>(<span class="fu">VectorSource</span>(Corona_NLP_DF<span class="sc">$</span>text))</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>Corona_dtm <span class="ot">&lt;-</span> <span class="fu">DocumentTermMatrix</span>(myCorpus)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You can have a look in your RStudio’s <code>Environment</code> section on the right, to see what’s in those variables.</p>
</section>
<section id="method-2-using-quanteda" class="level2">
<h2 class="anchored" data-anchor-id="method-2-using-quanteda">Method 2: Using <em>quanteda</em></h2>
<p>The package <code>quanteda</code> is a highly flexible package for text analysis, offering easy conversion of text dataframes to document-feature matrices (DFMs) with various weighting schemes, including TF and TF-IDF.</p>
<p>First let’s</p>
<ol type="1">
<li>Install and load quanteda (ok… we already did that at the top of the notebook with <code>pacman</code>, but in your own work you might choose to pacman it down here)</li>
<li>Create a Document-Feature Matrix (DFM) and Apply TF-IDF Weighting</li>
</ol>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a corpus and DFM from the dataframe</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>corpus <span class="ot">&lt;-</span> <span class="fu">corpus</span>(df, <span class="at">text_field =</span> <span class="st">"text"</span>)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>dfm <span class="ot">&lt;-</span> <span class="fu">dfm</span>(<span class="fu">tokens</span>(corpus))</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># View the DFM with term frequencies</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dfm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Document-feature matrix of: 3 documents, 12 features (58.33% sparse) and 0 docvars.
    features
docs john smith went to edinburgh alice swift lives in paris
   1    1     1    1  1         1     0     0     0  0     0
   2    0     0    0  0         0     1     1     1  1     1
   3    0     0    0  0         0     0     1     1  1     0
[ reached max_nfeat ... 2 more features ]</code></pre>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Apply TF-IDF weighting</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>dfm_tfidf <span class="ot">&lt;-</span> <span class="fu">dfm_tfidf</span>(dfm)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># View the TF-IDF weighted DFM</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dfm_tfidf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Document-feature matrix of: 3 documents, 12 features (58.33% sparse) and 0 docvars.
    features
docs      john     smith      went        to edinburgh     alice     swift
   1 0.4771213 0.4771213 0.4771213 0.4771213 0.4771213 0         0        
   2 0         0         0         0         0         0.4771213 0.1760913
   3 0         0         0         0         0         0         0.1760913
    features
docs     lives        in     paris
   1 0         0         0        
   2 0.1760913 0.1760913 0.4771213
   3 0.1760913 0.1760913 0        
[ reached max_nfeat ... 2 more features ]</code></pre>
</div>
</div>
<p><strong>If you see warnings at this point…</strong> When woring on our own computers (not Noteable) We have found sometimes there are depreciation warnings when using this packages and incompatibilities so recently I tend to use the tidytext and tm more. That said there are some excellent blogs where people have used quanteda particularly around politics to analyse textdata.</p>
<p><a href="https://cran.r-project.org/web/packages/quanteda/vignettes/quickstart.html">Here is the quanteda vignette</a> Feel free to look at some of the options when using the quanteda package.</p>
</section>
<section id="method-3-using-tidytext-and-dplyr-packages" class="level2">
<h2 class="anchored" data-anchor-id="method-3-using-tidytext-and-dplyr-packages">Method 3: Using tidytext and dplyr Packages</h2>
<p>The tidytext package enables the creation of DTMs in a tidy data format. This is particularly useful if you prefer dplyr workflows and want to manage term weighting manually.</p>
<p>In this next code block we will:</p>
<ol type="1">
<li>Install and load tidytext and dplyr</li>
<li>Unnest Tokens and Calculate Term Frequency (TF)</li>
<li>Calculate Inverse Document Frequency (IDF) and TF-IDF</li>
<li>Calculate IDF and TF-IDF values for each term</li>
</ol>
<p>You saw these steps last week in Week 2 Badges.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>pacman<span class="sc">::</span><span class="fu">p_load</span>(tidytext,dplyr)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Tokenize and calculate term frequency</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>df_tf <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_tokens</span>(word, text) <span class="sc">%&gt;%</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(doc_id, word, <span class="at">sort =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(doc_id) <span class="sc">%&gt;%</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">tf =</span> n <span class="sc">/</span> <span class="fu">sum</span>(n)) <span class="sc">%&gt;%</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>()</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_tf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 4
   doc_id word          n    tf
    &lt;int&gt; &lt;chr&gt;     &lt;int&gt; &lt;dbl&gt;
 1      1 edinburgh     1   0.2
 2      1 john          1   0.2
 3      1 smith         1   0.2
 4      1 to            1   0.2
 5      1 went          1   0.2
 6      2 alice         1   0.2
 7      2 in            1   0.2
 8      2 lives         1   0.2
 9      2 paris         1   0.2
10      2 swift         1   0.2
11      3 in            1   0.2
12      3 lives         1   0.2
13      3 swift         1   0.2
14      3 taylor        1   0.2
15      3 usa           1   0.2</code></pre>
</div>
</div>
<p>and then</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate document frequency</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>df_idf <span class="ot">&lt;-</span> df_tf <span class="sc">%&gt;%</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(word) <span class="sc">%&gt;%</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">df =</span> n)</span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Join with TF table and calculate TF-IDF</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>df_tfidf <span class="ot">&lt;-</span> df_tf <span class="sc">%&gt;%</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(df_idf, <span class="at">by =</span> <span class="st">"word"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">idf =</span> <span class="fu">log</span>(<span class="fu">n_distinct</span>(doc_id) <span class="sc">/</span> df),</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>         <span class="at">tf_idf =</span> tf <span class="sc">*</span> idf) <span class="sc">%&gt;%</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(doc_id, word, tf_idf)</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(df_tfidf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 15 × 3
   doc_id word      tf_idf
    &lt;int&gt; &lt;chr&gt;      &lt;dbl&gt;
 1      1 edinburgh 0.220 
 2      1 john      0.220 
 3      1 smith     0.220 
 4      1 to        0.220 
 5      1 went      0.220 
 6      2 alice     0.220 
 7      2 in        0.0811
 8      2 lives     0.0811
 9      2 paris     0.220 
10      2 swift     0.0811
11      3 in        0.0811
12      3 lives     0.0811
13      3 swift     0.0811
14      3 taylor    0.220 
15      3 usa       0.220 </code></pre>
</div>
</div>
<p>We would like a document term matrix in tidytext format.</p>
<p>To do this we will:</p>
<ol type="1">
<li><p>Create a tibble with term frequencies</p></li>
<li><p>Convert our tibble with term frequncies it to a Document-Term Matrix (DTM) using cast_dtm().</p></li>
</ol>
<p>The <code>cast_dtm()</code> function takes three arguments:</p>
<ul>
<li><p><code>document</code>: the column representing document IDs</p></li>
<li><p><code>term</code>: the column representing terms (words)</p></li>
<li><p><code>value</code>: the column representing term frequencies or counts</p>
<p>cast_dtm(doc_id, word, n): We are creating a DTM with doc_id as the rows (documents), word as the columns (terms), and n as the term frequency values.</p></li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tokenize and count term frequencies</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>term_counts <span class="ot">&lt;-</span> df <span class="sc">%&gt;%</span></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unnest_tokens</span>(word, text) <span class="sc">%&gt;%</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">count</span>(doc_id, word, <span class="at">sort =</span> <span class="cn">TRUE</span>)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(term_counts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    doc_id      word     n
     &lt;int&gt;    &lt;char&gt; &lt;int&gt;
 1:      1 edinburgh     1
 2:      1      john     1
 3:      1     smith     1
 4:      1        to     1
 5:      1      went     1
 6:      2     alice     1
 7:      2        in     1
 8:      2     lives     1
 9:      2     paris     1
10:      2     swift     1
11:      3        in     1
12:      3     lives     1
13:      3     swift     1
14:      3    taylor     1
15:      3       usa     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the tibble to a Document-Term Matrix</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>dtm <span class="ot">&lt;-</span> term_counts <span class="sc">%&gt;%</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cast_dtm</span>(<span class="at">document =</span> doc_id, <span class="at">term =</span> word, <span class="at">value =</span> n)</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a><span class="co"># View the DTM</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(dtm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 3, terms: 12)&gt;&gt;
Non-/sparse entries: 15/21
Sparsity           : 58%
Maximal term length: 9
Weighting          : term frequency (tf)</code></pre>
</div>
</div>
</section>
<section id="viewing-the-dtm" class="level2">
<h2 class="anchored" data-anchor-id="viewing-the-dtm">Viewing the DTM</h2>
<p>You can inspect the DTM by using inspect(dtm) if you want to see its structure:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Inspect the DTM#</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a><span class="co">#(from the tm package)</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>tm<span class="sc">::</span><span class="fu">inspect</span>(dtm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 3, terms: 12)&gt;&gt;
Non-/sparse entries: 15/21
Sparsity           : 58%
Maximal term length: 9
Weighting          : term frequency (tf)
Sample             :
    Terms
Docs alice edinburgh in john lives paris smith swift to went
   1     0         1  0    1     0     0     1     0  1    1
   2     1         0  1    0     1     1     0     1  0    0
   3     0         0  1    0     1     0     0     1  0    0</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate TF-IDF</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>term_tfidf <span class="ot">&lt;-</span> term_counts <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_tf_idf</span>(word, doc_id, n)</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the tibble with TF-IDF weights into a DTM</span></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>dtm_tfidf <span class="ot">&lt;-</span> term_tfidf <span class="sc">%&gt;%</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cast_dtm</span>(<span class="at">document =</span> doc_id, <span class="at">term =</span> word, <span class="at">value =</span> tf_idf)</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a><span class="co"># View the TF-IDF weighted DTM</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>tm<span class="sc">::</span><span class="fu">inspect</span>(dtm_tfidf)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;&lt;DocumentTermMatrix (documents: 3, terms: 12)&gt;&gt;
Non-/sparse entries: 15/21
Sparsity           : 58%
Maximal term length: 9
Weighting          : term frequency (tf)
Sample             :
    Terms
Docs     alice edinburgh         in      john     paris     smith    taylor
   1 0.0000000 0.2197225 0.00000000 0.2197225 0.0000000 0.2197225 0.0000000
   2 0.2197225 0.0000000 0.08109302 0.0000000 0.2197225 0.0000000 0.0000000
   3 0.0000000 0.0000000 0.08109302 0.0000000 0.0000000 0.0000000 0.2197225
    Terms
Docs        to       usa      went
   1 0.2197225 0.0000000 0.2197225
   2 0.0000000 0.0000000 0.0000000
   3 0.0000000 0.2197225 0.0000000</code></pre>
</div>
</div>
</section>
<section id="activity-read-your-corona-data-into-a-tidytext-document-term-matrix" class="level2">
<h2 class="anchored" data-anchor-id="activity-read-your-corona-data-into-a-tidytext-document-term-matrix">ACTIVITY: Read your corona data into a tidytext document term matrix</h2>
<p>If you’re feeling brave, try to write this code yourself. But if you are struggling after a few minutes, just look at the hint</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># below is some pseudo-code to get you started:</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Tokenize and count term frequencies</span></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the tibble to a Document-Term Matrix</span></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a><span class="co"># View the DTM</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p><a href="./hints/hint_7_2.Rmd">Hint: Answer</a></p>
</section>
<section id="word-embeddings---glove" class="level2">
<h2 class="anchored" data-anchor-id="word-embeddings---glove">Word Embeddings - GloVE 🧤</h2>
<p>We will load GloVE embeddings and have a look at the embedding document vector for the words. GloVE is a Standford project which generates and shares with the world word similarity matrix. It is really amazing, and explains quite well how it works <a href="https://nlp.stanford.edu/projects/glove/">on their website</a></p>
<p>This is a large download (a few minutes) so get the downloading started by running below code block, and meanwhile continue with notebook</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># first let's download the glove file, it is quite large</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="co"># this will take a few minutes, but meanwhile you can continue following the lesson </span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="co"># (but you won't be able to run code until the download is finished)</span></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="fu">options</span>(<span class="at">timeout =</span> <span class="dv">1200</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>filename_url <span class="ot">&lt;-</span> <span class="st">"https://nlp.stanford.edu/data/wordvecs/glove.2024.wikigiga.50d.zip"</span></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>filename_local <span class="ot">&lt;-</span> <span class="st">"./data/glove.2024.wikigiga.50d.zip"</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(filename_local)){</span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">download.file</span>(filename_url, filename_local) </span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unzip</span>(filename_local, <span class="at">exdir=</span><span class="st">"./data/"</span>) </span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that below operations will take a lot of memory, for people using environment with limited memory (like posit cloud) try to load just the first 100000 lines. (full file has almost 2 million lines).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># rm(list = setdiff(ls(), "")) # another way to have more memory os to clean your environment, like this</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(data.table)</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Specify the path to the GloVe file</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>glove_file_name <span class="ot">&lt;-</span> <span class="st">"./data/wiki_giga_2024_50_MFT20_vectors_seed_123_alpha_0.75_eta_0.075_combined.txt"</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Load GloVe embeddings (I find sometimes trying to read as a csv can cause memory issues depending on your set-up)</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>IF_MEMORY_IS_SPARESE_LOAD_JUST_THIS_MANY_WORDS <span class="ot">&lt;-</span> <span class="dv">100000</span> <span class="co"># to load everything, change this value to -1</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="co"># if you limit the word cooccurances here, keep in mind that some words will be missing (e.g. 'itemising')</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>glove_embeddings <span class="ot">&lt;-</span> <span class="fu">fread</span>(glove_file_name, <span class="at">header =</span> <span class="cn">FALSE</span>, <span class="at">quote =</span> <span class="st">" "</span>, <span class="at">nrows =</span> IF_MEMORY_IS_SPARESE_LOAD_JUST_THIS_MANY_WORDS)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Setting the column names based on 100-dimensional embeddings</span></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="fu">setnames</span>(glove_embeddings, <span class="fu">c</span>(<span class="st">"word"</span>, <span class="fu">paste0</span>(<span class="st">"V"</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">50</span>)))  </span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert the embeddings to a matrix and assign the words as teh row names</span></span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a>glove_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(glove_embeddings[, <span class="sc">-</span><span class="dv">1</span>, <span class="at">with =</span> <span class="cn">FALSE</span>])</span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a><span class="fu">rownames</span>(glove_matrix) <span class="ot">&lt;-</span> glove_embeddings<span class="sc">$</span>word</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In the <code>Environment</code> tab in RStudio click on <code>glove_matrix</code> to view the document vector for the embedding</p>
<p>We will now:</p>
<ul>
<li><p>calculate the similarity between two words based on their document vectors</p></li>
<li><p>find words similar to our input word</p></li>
</ul>
<p>Note this last one can take some time to compute.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute cosine similarity, i.e. take two numbers and do the math:</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a><span class="co"># notice we are creating our own function here, and call it cosine_similarity</span></span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>cosine_similarity <span class="ot">&lt;-</span> <span class="cf">function</span>(a, b) {</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sum</span>(a <span class="sc">*</span> b) <span class="sc">/</span> (<span class="fu">sqrt</span>(<span class="fu">sum</span>(a<span class="sc">^</span><span class="dv">2</span>)) <span class="sc">*</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(b<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we have all the necessary ingredients, let’s use them:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Similarity between two words</span></span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>word1 <span class="ot">&lt;-</span> <span class="st">"king"</span></span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>word2 <span class="ot">&lt;-</span> <span class="st">"queen"</span></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>similarity <span class="ot">&lt;-</span> <span class="fu">cosine_similarity</span>(glove_matrix[word1, ], glove_matrix[word2, ])</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(similarity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8095981</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Similarity between two words</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>word1 <span class="ot">&lt;-</span> <span class="st">"banana"</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>word2 <span class="ot">&lt;-</span> <span class="st">"queen"</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>similarity <span class="ot">&lt;-</span> <span class="fu">cosine_similarity</span>(glove_matrix[word1, ], glove_matrix[word2, ])</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(similarity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.3099832</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Similarity between two words</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>word1 <span class="ot">&lt;-</span> <span class="st">"banana"</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>word2 <span class="ot">&lt;-</span> <span class="st">"fruit"</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>similarity <span class="ot">&lt;-</span> <span class="fu">cosine_similarity</span>(glove_matrix[word1, ], glove_matrix[word2, ])</span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>similarity</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.7577182</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Example: Similarity between two words</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a><span class="co"># but this time let's measure how long it takes:</span></span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"start: "</span>,<span class="fu">Sys.time</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "start:  2025-10-31 17:10:24.595212"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>word1 <span class="ot">&lt;-</span> <span class="st">"banana"</span></span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>word2 <span class="ot">&lt;-</span> <span class="st">"yellow"</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>similarity <span class="ot">&lt;-</span> <span class="fu">cosine_similarity</span>(glove_matrix[word1, ], glove_matrix[word2, ])</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(similarity)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.5496727</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">paste</span>(<span class="st">"end on:"</span>,<span class="fu">Sys.time</span>()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "end on: 2025-10-31 17:10:24.596353"</code></pre>
</div>
</div>
<p>Here’s a more clearly written function which will calculate simmilarity of two words for us. Math is the same, but the ‘interface’ is better - we just give it two words and glove matrix, and the function does the magic for us, like this: <code>get_word_similarity("hospital", "clinic", glove_matrix)</code></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>get_word_similarity <span class="ot">&lt;-</span> <span class="cf">function</span>(word1, word2, glove_words_matrix) {</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract word vectors (inside of the function, yay!)</span></span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>  vec1 <span class="ot">&lt;-</span> glove_words_matrix[word1, ]</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a>  vec2 <span class="ot">&lt;-</span> glove_words_matrix[word2, ]</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-6"><a href="#cb68-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute norms</span></span>
<span id="cb68-7"><a href="#cb68-7" aria-hidden="true" tabindex="-1"></a>  norm1 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(vec1 <span class="sc">*</span> vec1))</span>
<span id="cb68-8"><a href="#cb68-8" aria-hidden="true" tabindex="-1"></a>  norm2 <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(vec2 <span class="sc">*</span> vec2))</span>
<span id="cb68-9"><a href="#cb68-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-10"><a href="#cb68-10" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute cosine similarity (same as before)</span></span>
<span id="cb68-11"><a href="#cb68-11" aria-hidden="true" tabindex="-1"></a>  similarity <span class="ot">&lt;-</span>   <span class="fu">sum</span>(vec1 <span class="sc">*</span> vec2) <span class="sc">/</span> (norm1 <span class="sc">*</span> norm2)</span>
<span id="cb68-12"><a href="#cb68-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb68-13"><a href="#cb68-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(similarity)</span>
<span id="cb68-14"><a href="#cb68-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb68-15"><a href="#cb68-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb68-16"><a href="#cb68-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Example use (with timings, this time with more 'human' units: seconds ):</span></span>
<span id="cb68-17"><a href="#cb68-17" aria-hidden="true" tabindex="-1"></a>time_start <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb68-18"><a href="#cb68-18" aria-hidden="true" tabindex="-1"></a><span class="fu">get_word_similarity</span>(<span class="st">"hospital"</span>, <span class="st">"clinic"</span>, glove_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.8823626</code></pre>
</div>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">Sys.time</span>() <span class="sc">-</span> time_start) <span class="co"># this is how long it took</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Time difference of 0.0005469322 secs</code></pre>
</div>
</div>
<p>And how would we get the list of e.g.&nbsp;10 words most co-occurring with the word we care about?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>get_connected_words <span class="ot">&lt;-</span> <span class="cf">function</span>(target_word, glove_words_matrix, <span class="at">how_many =</span> <span class="dv">10</span>){</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    target_vec <span class="ot">&lt;-</span> glove_words_matrix[target_word, ]</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>  <span class="co"># here, there is no second word! instead we care for similarities of every word. </span></span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    glove_norms <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">rowSums</span>(glove_words_matrix <span class="sc">*</span> glove_words_matrix))</span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>    target_norm <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">sum</span>(target_vec <span class="sc">*</span> target_vec))</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>    similarities <span class="ot">&lt;-</span> (glove_words_matrix <span class="sc">%*%</span> target_vec) <span class="sc">/</span> (glove_norms <span class="sc">*</span> target_norm)</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and here we will order those simmilarities and just grab thetop few.</span></span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>    similar_words_indexes <span class="ot">&lt;-</span> <span class="fu">order</span>(similarities, <span class="at">decreasing =</span> <span class="cn">TRUE</span>)[<span class="dv">1</span><span class="sc">:</span>how_many]  <span class="co"># Indexes of Top X similar words</span></span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>    similar_words <span class="ot">&lt;-</span> <span class="fu">rownames</span>(glove_words_matrix)[similar_words_indexes] <span class="co"># actual Top X similar words</span></span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>    similar_words</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb72-15"><a href="#cb72-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-16"><a href="#cb72-16" aria-hidden="true" tabindex="-1"></a><span class="co"># let's use it a few times. If you're keen, you can add our code from above which measured how long things take.</span></span>
<span id="cb72-17"><a href="#cb72-17" aria-hidden="true" tabindex="-1"></a><span class="fu">get_connected_words</span>(<span class="st">"hospital"</span>,glove_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "hospital"    "clinic"      "medical"     "hospitals"   "nursing"    
 [6] "psychiatric" "doctors"     "bellevue"    "school"      "nurse"      </code></pre>
</div>
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_connected_words</span>(<span class="st">"patient"</span>,glove_matrix, <span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "patient"     "patients"    "treatment"   "doctors"     "treating"   
 [6] "care"        "treat"       "mental"      "diagnosis"   "condition"  
[11] "brain"       "medical"     "psychiatric" "person"      "treated"    
[16] "heart"       "cancer"      "doctor"      "child"       "illness"    </code></pre>
</div>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="fu">get_connected_words</span>(<span class="st">"sick"</span>,glove_matrix)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code> [1] "sick"     "dying"    "treated"  "ill"      "treat"    "children"
 [7] "babies"   "cared"    "mothers"  "pregnant"</code></pre>
</div>
</div>
</section>
</section>
<section id="and-now-lets-use-our-function-many-many-times-ooooh-this-might-come-handy" class="level1">
<h1>and now let’s use our function many many times, ooooh! this might come handy:</h1>
<p>You could even batch apply this function:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>some_words <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">word =</span> <span class="fu">c</span>(<span class="st">"hospital"</span>, <span class="st">"clinic"</span>, <span class="st">"practice"</span>))</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>some_words_connectios <span class="ot">&lt;-</span> <span class="fu">apply</span>(some_words, <span class="dv">1</span>, get_connected_words, glove_matrix) </span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>some_words_connectios</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]          [,2]          [,3]        
 [1,] "hospital"    "clinic"      "practice"  
 [2,] "clinic"      "hospital"    "practiced" 
 [3,] "medical"     "clinics"     "practicing"
 [4,] "hospitals"   "medical"     "practices" 
 [5,] "nursing"     "nursing"     "learning"  
 [6,] "psychiatric" "psychiatric" "teaching"  
 [7,] "doctors"     "hospice"     "taking"    
 [8,] "bellevue"    "doctors"     "without"   
 [9,] "school"      "hospitals"   "reasons"   
[10,] "nurse"       "pediatric"   "classes"   </code></pre>
</div>
</div>
<p>Ok… this code is difficult. Especially the line starting with <code>apply...</code>. We will now take a few minutes to REALLY understand it. But of you are already very confident in your use of functions and apply, feel free to just down to the activity.</p>
<section id="a-word-from-our-sponsor-functions-and-apply" class="level2">
<h2 class="anchored" data-anchor-id="a-word-from-our-sponsor-functions-and-apply">A word from our sponsor: FUNCTIONS and APPLY</h2>
<p>Let’s recap a bit about <strong>FUNCTIONS</strong>. You build your own functions to EXTEND the R language, and add more functionality to it. For example R might not have a function <code>is_positive( some_number )</code> that will tell you if number is positive… so you can buuld it</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a>is_positive <span class="ot">&lt;-</span> <span class="cf">function</span>( some_number ){</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a>  some_number <span class="sc">&gt;</span> <span class="dv">0</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a><span class="co"># now you defined a function, you can call it as many times as you want:</span></span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a><span class="fu">is_positive</span>(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is_positive</span>(<span class="sc">-</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] FALSE</code></pre>
</div>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="fu">is_positive</span>(<span class="dv">83</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] TRUE</code></pre>
</div>
</div>
<p>Functions can take many arguments</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>nth_character <span class="ot">&lt;-</span> <span class="cf">function</span>( word, which_character ){</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">substr</span>(word, which_character, which_character)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a><span class="co"># now you defined a function, you can call it as many times as you want:</span></span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a><span class="fu">nth_character</span>(<span class="st">"banana"</span>, <span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "n"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nth_character</span>(<span class="st">"banana"</span>, <span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "a"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a><span class="fu">nth_character</span>(<span class="st">"kiwi"</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "k"</code></pre>
</div>
</div>
<p>But what if you wanted to apply a function many times, eg to each item in a collection?</p>
<p>Let’s dissect the onion-like code above, bit by bit. First:</p>
<ul>
<li><code>apply( collection, 1, function_name)</code></li>
</ul>
<p>It will apply will use/apply a function to each item in a collection of items. Number <code>1</code> means go row by row. <code>2</code> would mean go column by column.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>fruits <span class="ot">=</span> <span class="fu">data.frame</span>(<span class="at">name=</span><span class="fu">c</span>(<span class="st">"banana"</span>,<span class="st">"kiwi"</span>,<span class="st">"plum"</span>), </span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>                    <span class="at">color=</span><span class="fu">c</span>(<span class="st">"yellow"</span>,<span class="st">"green"</span>,<span class="st">"purple"</span>))</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>( fruits, <span class="dv">1</span>, nchar)  <span class="co"># this will apply nchar (number of characters) to each item</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1] [,2] [,3]
name     6    4    4
color    6    5    6</code></pre>
</div>
</div>
<p>but the really cool thing is that you do not have to limit yourself to just functions given to you by R like <code>nchar</code>. You could create your own. For example</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="co"># let's first create our own function: </span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a>describe_fruit <span class="ot">&lt;-</span> <span class="cf">function</span>(fruit){</span>
<span id="cb94-3"><a href="#cb94-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste</span>(fruit[<span class="st">'name'</span>],<span class="st">"is"</span>,fruit[<span class="st">'color'</span>])</span>
<span id="cb94-4"><a href="#cb94-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb94-5"><a href="#cb94-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb94-6"><a href="#cb94-6" aria-hidden="true" tabindex="-1"></a><span class="co"># you would not apply a function like that to a whole dataframe, because this would happen:</span></span>
<span id="cb94-7"><a href="#cb94-7" aria-hidden="true" tabindex="-1"></a>descriptions <span class="ot">&lt;-</span> <span class="fu">describe_fruit</span>(fruits)</span>
<span id="cb94-8"><a href="#cb94-8" aria-hidden="true" tabindex="-1"></a>descriptions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "c(\"banana\", \"kiwi\", \"plum\") is c(\"yellow\", \"green\", \"purple\")"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="co"># instead you'd apply it to individual items:</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>descriptions <span class="ot">&lt;-</span> <span class="fu">describe_fruit</span>(fruits[<span class="dv">1</span>,]) <span class="co"># just first row</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>descriptions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "banana is yellow"</code></pre>
</div>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a><span class="co"># or (the fun part) you can apply it to all rows at once:</span></span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>descriptions <span class="ot">&lt;-</span> <span class="fu">apply</span>(fruits, <span class="dv">1</span>, describe_fruit) </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>descriptions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "banana is yellow" "kiwi is green"    "plum is purple"  </code></pre>
</div>
</div>
<p>This bit is not always a good idea, but you will see it: you might even (fr very short functions, usually a one-liners) not define the function ahead of time, but put it right inside your apply, as an <code>unnamed function</code>. (btw. in python they are called <code>lambda</code>)</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># notice the function is defined right there where function name was.</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="co"># do you see that this gets messy for bigger functions?</span></span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>descriptions <span class="ot">&lt;-</span> <span class="fu">apply</span>(fruits, <span class="dv">1</span>, <span class="cf">function</span>(fruit) <span class="fu">paste</span>(fruit[<span class="st">'name'</span>],<span class="st">"is"</span>,fruit[<span class="st">'color'</span>]) ) </span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>descriptions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "banana is yellow" "kiwi is green"    "plum is purple"  </code></pre>
</div>
</div>
<p>And finally, if you function takes multiple arguments, you can just pass them on, inside your apply, like this:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>say_color_n_times <span class="ot">&lt;-</span> <span class="cf">function</span>(fruit, times){</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">strrep</span>(fruit[<span class="st">'color'</span>],times)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a><span class="co"># descriptions &lt;- apply(fruits, 1, say_color_n_times ) # this would freak out, since  say_color_n_times takes more than one argument</span></span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>descriptions <span class="ot">&lt;-</span> <span class="fu">apply</span>(fruits, <span class="dv">1</span>, say_color_n_times, <span class="dv">3</span> ) <span class="co"># this will repeat each fruit colour 3 times</span></span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>descriptions</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] "yellowyellowyellow" "greengreengreen"    "purplepurplepurple"</code></pre>
</div>
</div>
<p>So, to bring it back where we started:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>some_words <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="at">word =</span> <span class="fu">c</span>(<span class="st">"hospital"</span>, <span class="st">"clinic"</span>, <span class="st">"practice"</span>))</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>some_words_connections <span class="ot">&lt;-</span> <span class="fu">apply</span>(some_words, <span class="dv">1</span>, get_connected_words, glove_matrix, <span class="dv">10</span>) </span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>some_words_connections</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>      [,1]          [,2]          [,3]        
 [1,] "hospital"    "clinic"      "practice"  
 [2,] "clinic"      "hospital"    "practiced" 
 [3,] "medical"     "clinics"     "practicing"
 [4,] "hospitals"   "medical"     "practices" 
 [5,] "nursing"     "nursing"     "learning"  
 [6,] "psychiatric" "psychiatric" "teaching"  
 [7,] "doctors"     "hospice"     "taking"    
 [8,] "bellevue"    "doctors"     "without"   
 [9,] "school"      "hospitals"   "reasons"   
[10,] "nurse"       "pediatric"   "classes"   </code></pre>
</div>
</div>
</section>
<section id="activity-your-own-funcitons-similarity-word1-word2-and-words_similar_toword" class="level2">
<h2 class="anchored" data-anchor-id="activity-your-own-funcitons-similarity-word1-word2-and-words_similar_toword">ACTIVITY: Your own funcitons similarity( word1, word2) and words_similar_to(word)</h2>
<p>What could you do with the newly acquired ability to identify co-appearing words? Think of a simple scenario and write code which makes it happen. Try to write it as a function.</p>
<p>Some ideas: - given list of words (e.g.&nbsp;sick, ill) get a list of co-appearing words which they have in common e.g.&nbsp;all 2 words share co-occurrence with “treated”</p>
</section>
</section>
<section id="reflection" class="level1">
<h1>Reflection:</h1>
<p>Now is a good moment to write down your self reflection: think of 3 STARS (things that you learned in this badge), and 1 WISH: a thing you wish you understood better. You might also thing of what would you do to fulfil your wish. Write them down.</p>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion:</h1>
<p>You hopefully see how we are slowly building towards our code being able to understand the ‘meaning’ behind the words. But also you see that because of the COMPLEXITY of the mathematical calculations involved, even the simplest operation can take very long time.</p>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>